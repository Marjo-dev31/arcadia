<section class="animals-section">
    <h3>Section animaux</h3>
    <form
        #animalchoice="ngForm"
        name="animalchoice"
        (ngSubmit)="getVeterinaryReports(selectedAnimalOption)"
    >
        <label for="animal-veterinary">Sélectionner un animal : </label>
        <select
            name="animal"
            id="animal-veterinary"
            [(ngModel)]="selectedAnimalOption"
            required
        >
            @for(animal of animals; track animal.id) {
            <option [ngValue]="animal.id">
                {{ animal.firstname }} ({{ animal.breed}})
            </option>
            }
        </select>
        <button type="submit" class="submit-btn" [disabled]="selectedAnimalOption === undefined">Filtrer</button>
    </form>
    @if(animalchoice.submitted && selectedAnimalOption &&
    !veterinaryReports.length){
    <p>Il n'y pas encore de rapport associé à cet animal !</p>
    } 
    <table
        mat-table
        [dataSource]="dataSource"
        matSort
        matSortActive="date"
        matSortDirection="desc"
        matSortDisableClear
    >
        <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Date de visite
            </th>
            <td mat-cell *matCellDef="let report">{{ report.date | date:"dd/MM/yyyy"}}</td>
        </ng-container>
        <ng-container matColumnDef="healthcondition">
            <th mat-header-cell *matHeaderCellDef>Etat de santé</th>
            <td mat-cell *matCellDef="let report">
                {{ report.health }}
            </td>
        </ng-container>
        <ng-container matColumnDef="food">
            <th mat-header-cell *matHeaderCellDef>
                Nourriture recommandée
            </th>
            <td mat-cell *matCellDef="let report">{{ report.food }}</td>
        </ng-container>
        <ng-container matColumnDef="grammage">
            <th mat-header-cell *matHeaderCellDef>
                Grammage recommandé
            </th>
            <td mat-cell *matCellDef="let report">
                {{ report.grammage }}
            </td>
        </ng-container>
        <ng-container matColumnDef="healthconditiondetails">
            <th mat-header-cell *matHeaderCellDef>
                Détails de l'état de santé
            </th>
            <td mat-cell *matCellDef="let report">
                {{ report.details_condition }}
            </td>
        </ng-container>
        <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Modifier/Supprimer</th>
            <td mat-cell *matCellDef="let report">
                @if(role === 'Vétérinaire'){
                <mat-icon (click)="editReport(report.id)"
                    >create</mat-icon
                >
                <mat-icon (click)="deleteReport(report.id)"
                    >delete</mat-icon
                >
                } @else {
                <p>Non autorisé</p>
                }
            </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayColums"></tr>
        <tr mat-row *matRowDef="let row; columns: displayColums"></tr>
    </table>
     @if(role === 'Vétérinaire'){ 
    <mat-icon class="add-icon" (click)="toggleAddForm()"
        >{{addFormIsDisplay()? 'remove_circle_outline' : 'add_circle_outline'}}</mat-icon
    >
   }
</section>
<section [ngStyle]="{ display: addFormIsDisplay() ? 'block' : 'none' }">
    <form
        class="add-form"
        #form="ngForm"
        name="addform"
        (ngSubmit)="onSubmit(form)"
    >
        <label for="animal-add-veterinary"
            >Sélectionner un animal :
        </label>
        <select
            name="animal"
            id="anima-add-veterinary"
            [(ngModel)]="newReport.id_animal"
            #animal="ngModel"
            required
        >
            @for(animal of animals; track animal.id) {
            <option [ngValue]="animal.id">
                {{ animal.firstname }} ({{ animal.breed }})
            </option>
            }
        </select>
        @if(animal.invalid && animal.touched){
        <p class="alert">Un animal est requis</p>
        }
        <label for="food-add-veterinary"
            >Nourriture recommandée :</label
        >
        <input
            type="text"
            placeholder="Aliments recommandés"
            name="food"
            id="food-add-veterinary"
            [(ngModel)]="newReport.food"
            #food="ngModel"
            required
        />
        @if(food.invalid && food.touched){
        <p class="alert">Un type de nourriture est requis</p>
        }
        <label for="grammage-add-veterinary">Poids (en g) :</label>
        <input
            type="text"
            placeholder="Grammage recommandé"
            name="grammage"
            id="grammage-add-veterinary"
            [(ngModel)]="newReport.grammage"
            #grammage="ngModel"
            required
        />
        @if(grammage.invalid && grammage.touched){
        <p class="alert">Un grammage est requis</p>
        }
        <label for="health-add-veterinary"
            >Etat de santé général :</label
        >
        <input
            type="text"
            placeholder="Etat de santé actuel"
            name="health"
            id="health-add-veterinary"
            [(ngModel)]="newReport.health"
            #health="ngModel"
            required
        />
        @if(health.invalid && health.touched){
        <p class="alert">Un état de santé est requis</p>
        }
        <label for="details-add-veterinary">Détails de santé :</label>
        <textarea
            name="details_condition"
            id="details-add-veterinary"
            placeholder="Détails de la condition physique"
            cols="30"
            rows="10"
            [(ngModel)]="newReport.details_condition"
            #details_condition="ngModel"
        ></textarea>

        <label for="user-add-veterinary"
            >Sélectionner un rapporteur :
        </label>
        <select
            name="user"
            id="user-add-veterinary"
            [(ngModel)]="newReport.id_user"
            #user="ngModel"
            required
        >
            @for(user of users$ | async; track user.id) {
            <option [ngValue]="user.id">
                {{ user.firstname | titlecase }}
                {{ user.lastname | titlecase }}
            </option>
            }
        </select>
        @if(user.invalid && user.touched){
        <p class="alert">Un rapporteur est requis</p>
        }
        <button type="submit" class=" submit-btn" [disabled]="form.invalid">
            Enregistrer nouveau rapport
        </button>
    </form>
</section>
<section
    [ngStyle]="{ display: updateFormIsDisplay() ? 'block' : 'none' }"
>
    <form
        class="add-form"
        [formGroup]="updateForm"
        (ngSubmit)="updateReport(selectedAnimalOption)"
    >
        @for(animal of animals; track animal.id){
            @if(animal.id === this.selectedAnimalOption){
                <p>Animal selectionné : {{ animal.firstname | titlecase }}</p>
            }}
        <label for="food-update-veterinary"
            >Nourriture recommandée :</label
        >
        <input
            type="text"
            formControlName="food"
            id="food-update-veterinary"
        />
        @if(updateForm.controls['food'].invalid &&
        updateForm.controls['food'].touched){
        <div class="alert">Un type de nourriture est requis</div>
        }
        <label for="grammage-update-veterinary">Poids (en g) :</label>
        <input
            type="text"
            formControlName="grammage"
            id="grammage-update-veterinary"
        />
        @if(updateForm.controls['grammage'].invalid &&
        updateForm.controls['grammage'].touched){
        <div class="alert">Un grammage est requis</div>
        }
        <label for="health-update-veterinary"
            >Etat de santé général :</label
        >
        <input
            type="text"
            formControlName="health"
            id="health-update-veterinary"
        />
        @if(updateForm.controls['health'].invalid &&
        updateForm.controls['health'].touched){
        <div class="alert">Un état de santé est requis</div>
        }
        <label for="details-update-veterinary"
            >Détails de santé :</label
        >
        <textarea
            formControlName="details_condition"
            id="details-update-veterinary"
            cols="30"
            rows="10"
        ></textarea>
        <label for="selected-user-update-veterinary"
            >Sélectionner un rapporteur :
        </label>
        <select
            name="selected-user"
            id="user-update-veterinary"
            formControlName="id_user"
            required
        >
            @for(user of users$ | async ; track user.id) {
            <option [value]="user.id">
                {{ user.firstname | titlecase }}
                {{ user.lastname | titlecase }}
            </option>
            }
        </select>
        @if(updateForm.controls['id_user'].invalid &&
        updateForm.controls['id_user'].touched){
        <div class="alert">Un rapporteur est requis</div>
        }
        <button type="submit" class=" submit-btn" [disabled]="updateForm.invalid">
            Modifier rapport
        </button>
    </form>
    <mat-icon class="add-icon" (click)="closeUpdateForm()"
        >remove_circle_outline</mat-icon
    >
</section>